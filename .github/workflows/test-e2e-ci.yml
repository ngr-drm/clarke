name: test-e2e-ci

on:
  push:
    branches:
      - main
      - features/**
      - dependabot/**
  pull_request:
    branches:
      - main

jobs:
  docker:
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v1

      - name: setup docker
        uses: hoverkraft-tech/compose-action@v2.0.1
        with:
          compose-file: './docker-compose.yml'
          up-flags: '-d --build'
          down-flags: '-v'
        env:
          API_ENV: 'docker'
          PG_HOST: 'localhost'
          PG_HOST_DOCKER: 'db'
          PG_USER: 'postgres'
          PG_PASSWORD: 'docker'
          PG_DATABASE: 'docker'
          PG_PORT: 5432
          API_PORT: 3000

      - name: run tests
        env:
          API_ENV: 'docker'
          PG_HOST: 'localhost'
          PG_HOST_DOCKER: 'db'
          PG_USER: 'postgres'
          PG_PASSWORD: 'docker'
          PG_DATABASE: 'docker'
          PG_PORT: 5432
          API_PORT: 3000

        run: |
          docker-compose exec app pnpm run test:e2e:docker
